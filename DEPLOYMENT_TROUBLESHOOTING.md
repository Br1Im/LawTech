# Руководство по устранению проблем развертывания LawTech

## Проблемы

### 1. Ошибка Nginx при развертывании
При развертывании на Render возникала ошибка:
```
nginx: [emerg] нет раздела «события» в конфигурации
```

### 2. Корневой путь отдает API вместо фронтенда
По адресу `https://lawtech-p225.onrender.com/` отображался JSON ответ API:
```json
{"message":"LawTech API is running","status":"healthy"}
```
Вместо главной страницы фронтенда.

### Причины

1. **Nginx конфигурация**: Проблема возникала из-за неправильной интеграции Nginx в Docker контейнер.

2. **Конфликт маршрутизации**: В `server.js` был определен маршрут для корневого пути `/`, который перехватывал все запросы к главной странице и возвращал JSON ответ API вместо статических файлов фронтенда.

### Решение
1. **Обновлен Dockerfile** - теперь использует nginx:alpine как базовый образ
2. **Исправлена конфигурация nginx.conf** - добавлен правильный раздел events
3. **Создан startup скрипт** - правильно запускает и Node.js сервер, и nginx
4. **Исправлена маршрутизация в server.js**:
   - Удален маршрут `app.get('/', ...)` который перехватывал корневой путь
   - Health check endpoints перенесены на `/api/health` и `/api/status`
   - Теперь корневой путь обрабатывается Nginx для отдачи статических файлов фронтенда

### Структура исправленного Dockerfile
```dockerfile
# Stage 1: Сборка frontend
FROM node:18-alpine AS frontend-build
# ... сборка фронтенда

# Stage 2: Сборка backend  
FROM node:18-alpine AS backend-build
# ... сборка бэкенда

# Stage 3: Финальный образ с nginx
FROM nginx:alpine AS production
# ... установка Node.js и настройка
```

### Ключевые изменения в nginx.conf
- Добавлен раздел `events { worker_connections 1024; }`
- Исправлен upstream на `server localhost:3001`
- Настроено проксирование API запросов

## Тестирование локально

### Для Linux/macOS:
```bash
./test-docker.sh
```

### Для Windows:
```powershell
.\test-docker.ps1
```

## Развертывание исправленной версии на Render

### Шаги для обновления:

1. **Зафиксируйте изменения в Git**:
   ```bash
   git add .
   git commit -m "Fix: Remove root route conflict, move health checks to /api/*"
   git push origin main
   ```

2. **Обновите развертывание на Render**:
   - Зайдите в Dashboard Render
   - Найдите ваш сервис `lawtech-p225`
   - Нажмите "Manual Deploy" → "Deploy latest commit"
   - Или дождитесь автоматического развертывания

3. **Проверьте результат**:
   - `https://lawtech-p225.onrender.com/` - должна показывать фронтенд
   - `https://lawtech-p225.onrender.com/api/health` - health check API
   - `https://lawtech-p225.onrender.com/api/status` - status API
   - `https://lawtech-p225.onrender.com/crm` - CRM страница

### Альтернативные варианты развертывания:

#### Вариант 1: Docker развертывание
1. Убедитесь, что используется обновленный Dockerfile
2. Проверьте, что nginx.conf корректно копируется в образ
3. Порт должен быть 10000 (как указано в nginx.conf)

#### Вариант 2: Раздельное развертывание (render.yaml)
Используйте конфигурацию из render.yaml для раздельного развертывания frontend и backend.

## Проверка логов

При возникновении проблем всегда проверяйте логи:
1. В Render Dashboard перейдите в раздел Logs
2. Ищите ошибки, содержащие "nginx", "error", "failed"
3. Проверьте, что все сервисы запускаются в правильном порядке

## Частые проблемы и решения

### 1. Порты не совпадают
- nginx слушает порт 10000
- Node.js сервер должен работать на порту 3001
- Проверьте переменные окружения PORT

### 2. Файлы не найдены
- Убедитесь, что пути в COPY командах корректны
- Проверьте, что frontend собирается в правильную директорию

### 3. Права доступа
- Startup скрипт должен быть исполняемым (chmod +x)
- Директории логов nginx должны существовать

## Мониторинг

После успешного развертывания:
1. Проверьте доступность по основному URL
2. Протестируйте API эндпоинты (/api/...)
3. Убедитесь, что статические файлы загружаются
4. Проверьте логи на наличие предупреждений

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи развертывания
2. Сравните с рабочей конфигурацией
3. Используйте тестовые скрипты для локальной проверки
4. Обратитесь к документации Render: https://render.com/docs/troubleshooting-deploys